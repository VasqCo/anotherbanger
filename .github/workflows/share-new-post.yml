name: Share New Posts

on:
  push:
    branches: [main]
    paths:
      - '_posts/**/*.md'
      - '_posts/**/*.markdown'
  workflow_dispatch:

jobs:
  tweet:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect newly added posts
        id: detector
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            BEFORE="$(git rev-list --max-parents=0 HEAD)"
          fi
          git diff --name-status "$BEFORE" ${{ github.sha }} -- '_posts/**/*.md' '_posts/**/*.markdown' | awk '$1 == "A" {print $2}' > new_posts.txt
          if [ ! -s new_posts.txt ]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "found=true" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        if: steps.detector.outputs.found == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.detector.outputs.found == 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml tweepy

      - name: Publish tweets for new posts
        if: steps.detector.outputs.found == 'true'
        env:
          SITE_BASE_URL: https://anotherbanger.net
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |
          python .github/scripts/post_new_tweets.py
